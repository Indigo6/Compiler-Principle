# 编译原理实验四：语法分析器功能扩展

## 一、实验目的：

######①为之前写好的语法分析器添加规范的报错；

######②进行功能扩展，集齐12颗星。

## 二、实验环境：

Win10系统下虚拟机VMware搭载的Ubuntu16.04系统。

## 三、实验内容：

######①任务分配：

​	首先是报错部分。语法分析中很多错误情况我们在实验三中已经考虑到了，需要做的是完善词法分析器的报错，适应助教提供的报错函数，以及把之前写的报错统一化。因此，词法分析部分的报错处理我们基本是平均分配，语法分析部分的报错则根据报错位置对应实验三中负责部分的位置进行分配。

​	其次是实现拓展功能。经过商讨，我们决定扩展后五项功能，即“返回值”“elif”“while do”“值传递”和“负数”。组长江学强主动请缨做“返回值”，而方林在实验三中负责的部分包括if、while，正好继续补充elif和while do，我则负责“值传递”和“负数”部分。

###### ②实现流程和个人工作：

​	首先是报错的实现。词法分析的报错较为简单，我负责的报错有“id以数字开头”“字符过长”“：=缺漏”和“！=缺漏”，在原有基础上增加一些变量、对状态机略作修改便完成了。但语法分析中问题就比较不乐观了：仔细阅读实验要求，我们发现报错的同时需要标明错误位置，还要把一整行代码打印出来，而语法分析中的一些错误往往会在这一行以后才发现，例如分号缺失、begin end 不配对等，此时打印出的一行代码往往并非问题所在。在打印和复位的过程中，我们还发现“\t”字符非常不友好，读入时只有2位，而实际作为文件操作却占了4位，一度让我们的报错上下错位。为了完成实验要求，我们编写了一个中间函数print_error作为中转，在词法分析中加入offset与real offset，总算把原有的报错完成了。

​	拓展功能的实现，我的任务之一的负数其实问题不大，因为在词法分析器部分我在一开始就考虑了负数的情况，后来实验要求突变后把相关代码注释掉了，现在修改一下状态机、把一些代码改回来，就能较好地兼容负数了。同时，还修改了对应语法分析相关的first集、follow集。

​	而任务之二的参数传递就非常玄学了。起初，我以为参数传递的函数在声明时应该同C语言一致，毕竟实验要求里说还要做简单的类型检查，于是按照 procedure id（var a，const b）的方式去构造了产生式，后来参考助教lab4的example发现，应该按照python式的动态匹配函数来写，正规的传参函数声明是 procedure id（n）。在语法分析过程中，对这样的函数应该如何判断其变量类型？函数声明后的相关信息应该存到哪里，供函数调用时进行检查？这实在让我写的头皮发麻。且考虑到多数编程语言中函数的参数允许计算式，例如可以写add（a+b，c+d），甚至可以写add（add（a,b）*c,add(c,d))，那么参数能接受的类型其实应该是一个表达式，如何在表达式移进规约过程中完成类型检查，也是一大难题。

​	经过一段时间的抓耳挠腮，我改写了语法产生式、增设6~7个函数，修改表达式、语句等各函数中对应的first集、follow集，终于让参数传递功能能在语法分析过程中正常地移进规约，但类型检查仍找不到门道，我们编写的语法分析器只在乎token的TYPE，然后进行移进规约，并不关心这个token具体是什么，比如x:=1会识别成id ：= num，y：=1也会识别成id：=num，这种一视同仁的背景下如何通过id来辨识一个函数，进而检查它括号内的参数是否合规呢？似乎在语义分析时再去处理类型要方便得多？

​	在工作的后期，我们还发现助教提供的报错函数打印的位置飘忽不定，时常嵌入到忽高忽低的位置，让人摸不着头脑。

​	个人工作：词法报错：数字过长,id开头错误,：=缺=，！=缺=。

​	语法报错：左右括号匹配不当，符号输入不全，缺漏分隔符等。

​	补充了数个应有的语法报错。

​	扩展功能：负数，值传递。支持以运算式、表达式的形式传值。

​	以及老生常谈的debug等等。

###### ③遇到的问题和解决方案：

​	问题一：报错位置不对、报错内容错位？通过改写状态机、产生式、FIRST集与FOLLOW集，编写print_error函数，设置real_offset变量记录文件中的实际字符偏移量等方式解决。

​	问题二：拓展功能之间存在联系，牵一发而动全身？例如返回值和值传递这两个扩展功能，实际上相互会产生影响，值传递需要对返回值提供支持，才能让形如func A（F(b)）的写法跑通。通过加写、改写产生式、交流协作解决。

​	问题三：各种一言难尽的bug，通过单步调试一点一点找出问题加以解决。

## 四、小结

​	本次实验可以说是上一次实验的补强和完善，但实验中我们为了添加报错和扩展功能，对原有产生式进行了很多改动，函数的形式也改了不少。若一开始就把这些功能加入到语法分析器中，把规范的报错形式设计好，我们从头开始搭建，可以省下非常多的工作，至少不用非常纠结地反复研读几周前的代码。

​	总而言之，历经艰辛的语法分析器到此应该能稍微告一段落了，在接下来的实验中要更加严谨、细致。

​	

